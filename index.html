<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>Random Gifinator</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <style>
        html, body {
            margin:0;
            overflow:hidden;
        }

        img.wide {
            height:100vh;
            -webkit-transform:translateX(-50%);
            margin-left:50%;
        }

        img.tall {
            width:100vw;
            -webkit-transform:translateY(-50%);
            margin-top:50%;
        }

        </style>
    </head>
    <body>
        <main>
            <img />
        </main>

        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
        <script>
        $(document).ready(function(){
            //if we pass it a hash, it's assumed that should be the featured gif name
            if (window.location.hash) {
                var hash = window.location.hash.substring(1); //Puts hash in variable, and removes the # character
                window.featuredGif = hash + '.gif';
            } 

            $.ajax({
                url : '/list_files.php',
                dataType : 'json',
                success: function(data, status, jqXHR){
                    window.gifList = data;

                    // if the featured gif we pass is not actually available, we default to the first in the folder
                    if ($.inArray(window.featuredGif, window.gifList) == -1) window.featuredGif = window.gifList[0];

                    showRandomGif();
                    cycleGifs();
                }
            });

            // we poll the server to unify our clocks and avoid inconsitency between open browsers
            checkServerTime();
        });

        function checkServerTime() {
            $.ajax({
                url : '/server_time.php',
                dataType : 'json',
                success: function(data, status, jqXHR){
                    //upon successfully polling the server, we clear our own time counter so we can resync with the server.
                    clearInterval(window.timestampInterval);

                    window.serverTime = new Date(data.date);
                    window.serverTimeStamp = window.serverTime.getTime()/1000;

                    //after we get the date and convert it to a timestamp in unix seconds, we now start increasing it ourselves to avoid constantly polling the server. 
                    updateTimeStamp();
                }
            });
        }

        function updateTimeStamp() {
            window.timestampInterval = setInterval(function(){
                // every second we increase the timestamp by 1
                window.serverTimeStamp += 1;

                // after 5 minutes resync with server 
                if (window.serverTimeStamp%(60*5) == 0) {
                    checkServerTime();
                }
                
                if (window.serverTimeStamp%(60) == 0) {
                    displayGif(window.featuredGif);
                    clearInterval(window.cycleGifsInterval);

                    setTimeout(function(){
                        showRandomGif();
                        cycleGifs();
                    }, 10000);
                }                
            }, 1000);
        }

        function cycleGifs() {
            window.cycleGifsInterval = setInterval(showRandomGif, 5000);
        }

        function showRandomGif() {
            var randomGif = window.gifList[Math.floor(Math.random() * window.gifList.length)];
            displayGif(randomGif);
        }

        function displayGif(filename) {
            var $img = $('img');
            $img.attr('src', '/images/'+filename);
            resizeImage($img);
        }

        function resizeImage($img) {   
            var newimage = new Image();
            var originalImageWidth;
            var originalImageHeight;
            
            newimage.src = $img.attr('src');
            newimage.onload = function()
            {
                originalImageWidth = this.naturalWidth;
                originalImageHeight = this.naturalHeight;

                var imageAspect = originalImageWidth / originalImageHeight;
                var windowAspect = $(window).width()/$(window).height();

                console.log(windowAspect);
                console.log(imageAspect);
            
                if (windowAspect > imageAspect) {
                    $img.removeClass().addClass('tall');
                }
                else {
                    $img.removeClass().addClass('wide');
                }
            }
        }
        </script>
    </body>
</html>