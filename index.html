<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>Random Gifinator</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <style>
        html, body {
            margin:0;
            overflow:hidden;
        }
        img {
            position:relative;
        }

        .static {
            width:100vw;
            height:100vh;
            position:absolute;
            top:0;
            left:0;
        }
        </style>
    </head>
    <body>
        <main>
            <img class="gif" />
            <img class="static" src="/images/static.gif"/>
        </main>

        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
        <script>
        $(document).ready(function(){
            //if we pass it a hash, it's assumed that should be the featured gif name
            if (window.location.hash) {
                var hash = window.location.hash.substring(1); //Puts hash in variable, and removes the # character
                window.featuredGif = hash + '.gif';
            } 

            $.ajax({
                url : '/list_files.php',
                dataType : 'json',
                success: function(data, status, jqXHR){
                    window.gifList = data;

                    // if the featured gif we pass is not actually available, we default to the first in the folder
                    if ($.inArray(window.featuredGif, window.gifList) == -1) window.featuredGif = window.gifList[0];

                    showRandomGif();
                    cycleGifs();
                }
            });

            // we poll the server to unify our clocks and avoid inconsitency between open browsers
            checkServerTime();
        });

        function checkServerTime() {
            $.ajax({
                url : '/server_time.php',
                dataType : 'json',
                success: function(data, status, jqXHR){
                    //upon successfully polling the server, we clear our own time counter so we can resync with the server.
                    clearInterval(window.timeStampInterval);

                    window.serverTime = new Date(data.date);
                    window.serverTimeStamp = window.serverTime.getTime()/1000;

                    //after we get the date and convert it to a timestamp in unix seconds, we now start increasing it ourselves to avoid constantly polling the server. 
                    updateTimeStamp();
                }
            });
        }

        function updateTimeStamp() {
            window.timeStampInterval = setInterval(function(){
                // every second we increase the timestamp by 1
                window.serverTimeStamp += 1;

                // after 5 minutes resync with server 
                if (window.serverTimeStamp%(60*5) == 0) {
                    checkServerTime();
                }
                
                // every minute sync all displays to show featured gif
                if (window.serverTimeStamp%(60) == 0) {
                    syncFeaturedGifs();
                }                
            }, 1000);
        }

        function syncFeaturedGifs() {
            displayGif(window.featuredGif);
            clearInterval(window.cycleGifsInterval);

            setTimeout(function(){
                showRandomGif();
                cycleGifs();
            }, 10000);
        }

        function cycleGifs() {
            window.cycleGifsInterval = setInterval(showRandomGif, 5000);
        }

        function showRandomGif() {
            var randomGif = window.gifList[Math.floor(Math.random() * window.gifList.length)];

            // if the list returns something without a .gif extension, try again. 
            if (randomGif.indexOf(".gif") == -1 ) {
                randomGif = window.gifList[Math.floor(Math.random() * window.gifList.length)];
            }

            displayGif(randomGif);
        }

        function displayGif(filename) {
            var $img = $('.gif'); 

            // show static transition between images, will display for loadtime + 150ms        
            $('.static').show();            
            
            $img.attr('src', '/images/gifs/' + filename);
            prepareImage($img);
        }

        function prepareImage($img) {   
            var newimage = new Image();
            var originalImageWidth;
            var originalImageHeight;
            
            newimage.src = $img.attr('src');
            newimage.onload = function()
            {
                // hide static transition now that image is loaded
                setTimeout(function(){
                    $('.static').hide();
                }, 150);

                // resize/reposition image based on aspect ratio relative to viewport aspect to make sure it is always fullscreen and centered
                originalImageWidth = this.naturalWidth;
                originalImageHeight = this.naturalHeight;

                var imageAspect = originalImageWidth / originalImageHeight;
                var windowAspect = $(window).width()/$(window).height();
            
                if (windowAspect > imageAspect) {
                    $img.width($(window).width()).height('auto');
                    // shift the element up
                    var height = $img.height();
                    var shift = (height - $(window).height()) / 2;
                    if (shift < 0) shift = 0;
                    $img.css({
                        "top" : -shift,
                        "left" : 0
                    });
                }
                else {

                    $img.height($(window).height()).width('auto');
                    // shift the element left
                    var width = $img.width();
                    var shift = (width -  $(window).width()) / 2;
                    if (shift < 0) shift = 0;
                    $img.css({
                        "left" : -shift,
                        "top" : 0
                    });
                }
            }
        }
        </script>
    </body>
</html>